#!/usr/bin/env python
import sys
import os
import pilot

if __name__ == '__main__':
    fname = None
    args = {}
    target = None
    verbose = False

    last = None
    for arg in sys.argv[1:]:
        if last:
            if last == 'f':
                if fname:
                    sys.stderr.write("You can only specify one file (-f)!\n")
                    sys.exit(1)
                if not os.path.exists(arg):
                    sys.stderr.write("Can't find file: %s\n", arg)
                    sys.exit(1)
                fname = arg
            else:
                if last in args:
                    args[last] = [args[last], arg]
                else:
                    args[last] = arg
            last = None
        elif arg == '-v':
            verbose = True
        elif arg[0] == '-':
            last = arg[1:]
        elif not target:
            target = arg
        else:
            sys.stderr.write("Don't know how to deal with argument: %s\n" % arg)
            sys.exit(1)

    if not fname:
        fname = 'Pilotfile'

    pipe = pilot.parse(fname, args, verbose=verbose)
    jobs = pipe.build(target)
    if jobs:
        for job in jobs:
            job._dump()
